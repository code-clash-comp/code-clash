<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel | Code Clash 2025</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="dashboard.css">
  <link rel="icon" type="image/png" href="logo.png">
  <style>
    /* admin-specific polish */
    .admin-stage { max-width: 1100px; margin: 18px auto 100px; }
    .admin-header { display:flex; flex-direction:column; gap:12px; margin-bottom:12px; }
    .admin-title { margin:0; font-family:var(--mono); color:var(--accent); font-size:26px; }
    .admin-sub { color:var(--muted); font-size:13px; margin-top:4px; }

    /* stats + search row: more compact, elevated card look */
    .stats-search-row {
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-top:6px;
      width:100%;
    }

    .left-stats {
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }

    .stat-pill {
      display:flex;
      flex-direction:column;
      gap:6px;
      padding:10px 14px;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.006));
      border:1px solid rgba(255,255,255,0.03);
      min-width:140px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.45);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .stat-pill:hover { transform: translateY(-4px); box-shadow: 0 18px 36px rgba(0,0,0,0.55); }
    .stat-label { color: var(--accent); font-weight:700; font-size:13px; letter-spacing:0.2px; }
    .stat-value { color: #ffffff; font-weight:900; font-size:18px; }

    /* right-side search block */
    .search-block {
      display:flex;
      align-items:center;
      gap:10px;
      background: rgba(255,255,255,0.012);
      border:1px solid rgba(255,255,255,0.03);
      padding:8px;
      border-radius:12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.45);
    }

    /* input with integrated icon */
    .search {
      background: transparent;
      border: none;
      padding:8px 10px 8px 34px;
      border-radius:8px;
      color:#e8f6e8;
      font-family:var(--mono);
      min-width:260px;
      outline:none;
      position:relative;
    }
    .search::placeholder{ color: rgba(230,240,230,0.5); }
    .search:focus { box-shadow: 0 8px 24px rgba(0,0,0,0.6), 0 0 10px rgba(127,191,127,0.03) inset; }

    /* search icon (CSS) */
    .search-icon {
      position:relative;
      width:28px;
      height:28px;
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-size:14px;
      margin-left:6px;
      pointer-events:none;
    }

    .top-actions { display:flex; gap:8px; align-items:center; }

    .admin-table { width:100%; border-collapse:collapse; margin-top:12px; border-radius:8px; overflow:hidden; }
    .admin-table thead tr { background: linear-gradient(90deg, rgba(127,191,127,0.06), rgba(95,160,95,0.03)); }
    .admin-table th, .admin-table td {
      text-align:left;
      padding:10px 12px;
      font-size:13px;
      border-bottom:1px solid rgba(255,255,255,0.02);
      color: #e6f2e6;
    }
    .admin-table th { color: var(--accent); font-weight:700; font-size:13px; }
    .small-muted { color: var(--muted); font-size:12px; }
    .role-badge { padding:6px 8px; border-radius:8px; font-weight:700; font-size:12px; display:inline-block; min-width:72px; text-align:center; }
    .badge-admin { background: rgba(255,255,255,0.02); color: var(--accent); border:1px solid rgba(143,217,155,0.04); }
    .badge-super { background: rgba(180,120,255,0.06); color: #c7b7ff; border:1px solid rgba(180,120,255,0.06); }
    .table-actions button { margin-left:6px; }
    .note { margin-top:8px; color:var(--muted); font-size:13px; }
    .inline-ctrls { display:flex; gap:8px; align-items:center; }

    @media (max-width:980px){
      .admin-stage{ padding:8px; }
      .admin-table th:nth-child(4), .admin-table td:nth-child(4) { display:none; } /* hide phone on small */
      .stats-search-row { flex-direction:column; align-items:flex-start; gap:10px; }
      .search { min-width:180px; }
    }
  </style>
</head>
<body>
  <div class="nav">
    <div class="nav-name">
      <h1 class="nav-name-title">&lt;/&gt; Code Clash 2025</h1>
    </div>

    <div class="nav-actions">
      <button class="nav-actions-register" id="navHome">Home</button>
      <button class="nav-actions-login" id="navLogin">Login</button>
    </div>
  </div>

  <div class="admin-stage container">
    <header class="admin-header">
      <div>
        <h2 class="admin-title">Admin Panel</h2>
        <div class="admin-sub">View registered participants â€¢ manage admin roles â€¢ quick audit</div>
      </div>

      <div class="stats-search-row">
        <div class="left-stats">
          <div class="stat-pill" title="Count of participants (admins excluded)">
            <div class="stat-label">Participants</div>
            <div id="statParticipants" class="stat-value">â€”</div>
          </div>

          <div class="stat-pill">
            <div class="stat-label">Admins</div>
            <div id="statAdmins" class="stat-value">â€”</div>
          </div>

          <div class="stat-pill">
            <div class="stat-label">Total users</div>
            <div id="statTotal" class="stat-value">â€”</div>
          </div>
        </div>

        <div class="search-block" role="search" aria-label="User search">
          <div class="search-icon">ðŸ”Ž</div>
          <input id="filterInput" class="search" placeholder="Search name, email, team..." />
          <div class="top-actions">
            <button id="refreshBtn" class="btn">Refresh</button>
          </div>
        </div>
      </div>
    </header>

    <section class="panel">

      <table class="admin-table" id="usersTable" aria-live="polite">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Grade</th>
            <th>Phone</th>
            <th>Team</th>
            <th>Role</th>
            <th>Admin</th>
            <th style="text-align:right">Actions</th>
          </tr>
        </thead>
        <tbody id="usersTbody">
          <tr><td colspan="8" class="small-muted">Loading usersâ€¦</td></tr>
        </tbody>
      </table>
    </section>
  </div>

  <footer class="page-foot muted">Hosted on GitHub Pages Â· Good luck and have fun!</footer>

<script type="module">
(async function(){
  // ---------- CONFIG ----------
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyDpKPIqiWrGpvE3xL6TBRQEEfrpZGIfedM",
    authDomain: "code-clash-2025.firebaseapp.com",
    projectId: "code-clash-2025",
    storageBucket: "code-clash-2025.appspot.com",
    messagingSenderId: "13717806434",
    appId: "1:13717806434:web:8aa7799e7f87ebbdf0603b",
    measurementId: "G-0BMTHMYMEL"
  };
  // ----------------------------

  // DOM refs
  const navHome = document.getElementById('navHome');
  const navLogin = document.getElementById('navLogin');
  const usersTbody = document.getElementById('usersTbody');
  const refreshBtn = document.getElementById('refreshBtn');
  const filterInput = document.getElementById('filterInput');
  const statParticipants = document.getElementById('statParticipants');
  const statAdmins = document.getElementById('statAdmins');
  const statTotal = document.getElementById('statTotal');

  navHome.onclick = ()=> window.location.href = '/code-clash/';

  // firebase imports (modular)
  const [
    { initializeApp },
    { getFirestore, collection, doc, onSnapshot, updateDoc, getDoc },
    { getAuth, onAuthStateChanged, signOut }
  ] = await Promise.all([
    import('https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js'),
    import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js'),
    import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js')
  ]).catch(err => { console.error('firebase import failed', err); throw err; });

  const app = initializeApp(FIREBASE_CONFIG);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // state
  let currentUser = null;
  let currentUserClaims = {};
  let isSuperAdmin = false;
  let isAdmin = false;
  let users = []; // array of { uid, ...doc }
  let teams = []; // teams snapshot to resolve memberships

  // ---------- guard: allow only admins/superAdmin ----------
  function adminDenied() {
    alert('Admin access required. Redirecting to home.');
    window.location.href = '/code-clash/';
  }

  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    if(!user) return adminDenied();

    // Try to read custom claims (preferred)
    try {
      const tokenRes = await user.getIdTokenResult();
      currentUserClaims = tokenRes.claims || {};
      isAdmin = !!(currentUserClaims.admin || currentUserClaims.isAdmin);
      isSuperAdmin = !!(currentUserClaims.superAdmin || currentUserClaims.isSuperAdmin);
    } catch(e) {
      console.warn('getIdTokenResult failed', e);
    }

    // If no admin claims, fallback to checking users/{uid} doc
    if(!isAdmin && !isSuperAdmin){
      try {
        const userRef = doc(db, 'users', user.uid);
        const snap = await getDoc(userRef);
        const data = snap.exists() ? snap.data() : {};
        isAdmin = !!data.isAdmin;
        isSuperAdmin = !!data.isSuperAdmin;
      } catch(e){
        console.warn('fallback users doc check failed', e);
      }
    }

    if(!isAdmin && !isSuperAdmin) return adminDenied();

    // show "Logout" on nav
    if(navLogin){
      navLogin.textContent = 'Logout';
      navLogin.onclick = async ()=> {
        if(!confirm('Logout?')) return;
        try { await signOut(auth); } catch(e){ console.error(e); }
        window.location.href = '/';
      };
    }

    // start listeners after guard
    startListeners();
  });

  // ---------- listeners: users + teams ----------
  function startListeners(){
    onSnapshot(collection(db, 'teams'), (snap) => {
      teams = [];
      snap.forEach(d => teams.push({ id:d.id, ...d.data() }));
      renderTable(); // re-render when teams change
    }, err => console.error('teams listener', err));

    onSnapshot(collection(db, 'users'), (snap) => {
      users = [];
      snap.forEach(d => users.push({ uid: d.id, ...d.data() }));
      renderTable();
    }, err => console.error('users listener', err));
  }

  // ---------- UI helpers ----------
  function lookupTeamForUser(uid){
    const t = teams.find(team => (team.members || []).includes(uid));
    if(!t) return { name: '-', id: null, isCaptain: false };
    return { name: t.name || 'Unnamed', id: t.id, isCaptain: t.captainUid === uid };
  }

  function sanitize(s){ return (s === undefined || s === null) ? '-' : String(s); }

  function renderTable(){
    const q = (filterInput.value || '').trim().toLowerCase();
    const filtered = users
      .slice()
      .sort((a,b)=> ( (a.name||a.email||'').localeCompare(b.name||b.email||'')) )
      .filter(u => {
        if(!q) return true;
        const hay = `${u.name||''} ${u.email||''} ${u.grade||''} ${lookupTeamForUser(u.uid).name||''}`.toLowerCase();
        return hay.includes(q);
      });

    // participant counts: exclude users flagged as admin or super-admin.
    // Include the currently signed-in user only if they are a normal registered user (i.e. appear in users and not admin).
    const participantCount = users.reduce((acc,u) => {
      if(u.isAdmin || u.isSuperAdmin) return acc;
      return acc + 1;
    }, 0);

    const adminCount = users.reduce((acc,u) => acc + ((u.isAdmin || u.isSuperAdmin) ? 1 : 0), 0);
    const totalUsers = users.length;

    // update stats UI
    statParticipants.textContent = String(participantCount);
    statAdmins.textContent = String(adminCount);
    statTotal.textContent = String(totalUsers);

    if(filtered.length === 0){
      usersTbody.innerHTML = `<tr><td colspan="8" class="small-muted">No users found.</td></tr>`;
      return;
    }

    usersTbody.innerHTML = '';
    for(const u of filtered){
      const team = lookupTeamForUser(u.uid);
      const tr = document.createElement('tr');

      const nameTd = document.createElement('td'); nameTd.textContent = sanitize(u.name || u.displayName || '-');
      const emailTd = document.createElement('td'); emailTd.textContent = sanitize(u.email || '-');
      const gradeTd = document.createElement('td'); gradeTd.textContent = sanitize(u.grade || '-');
      const phoneTd = document.createElement('td'); phoneTd.textContent = sanitize(u.phone || '-');

      const teamTd = document.createElement('td');
      if(team.id){
        teamTd.innerHTML = `${escapeHtml(team.name)} ${team.isCaptain ? '<span class="small-muted"> (captain)</span>' : ''}`;
      } else {
        teamTd.textContent = '-';
      }

      const roleTd = document.createElement('td');
      if(team.id) roleTd.innerHTML = team.isCaptain ? '<span class="role-badge badge-admin">Captain</span>' : '<span class="role-badge">Member</span>';
      else roleTd.textContent = '-';

      const adminTd = document.createElement('td');
      if(u.isSuperAdmin) adminTd.innerHTML = '<span class="role-badge badge-super">Super</span>';
      else if(u.isAdmin) adminTd.innerHTML = '<span class="role-badge badge-admin">Admin</span>';
      else adminTd.textContent = '-';

      const actionsTd = document.createElement('td'); actionsTd.style.textAlign = 'right';
      actionsTd.className = 'table-actions';

      if(isSuperAdmin){
        if(u.isSuperAdmin){
          const label = document.createElement('span'); label.className='small-muted'; label.textContent='â€”';
          actionsTd.appendChild(label);
        } else if(u.isAdmin){
          const demote = document.createElement('button'); demote.className='btn'; demote.textContent='Demote';
          demote.onclick = async ()=> {
            if(!confirm(`Demote ${u.name || u.email}?`)) return;
            try {
              await updateDoc(doc(db,'users',u.uid), { isAdmin: false });
              alert('Demoted.');
            } catch(e){ console.error(e); alert('Failed to demote (check rules).'); }
          };
          actionsTd.appendChild(demote);
        } else {
          const promote = document.createElement('button'); promote.className='btn primary'; promote.textContent='Promote';
          promote.onclick = async ()=> {
            if(!confirm(`Promote ${u.name || u.email} to admin?`)) return;
            try {
              await updateDoc(doc(db,'users',u.uid), { isAdmin: true });
              alert('Promoted.');
            } catch(e){ console.error(e); alert('Failed to promote (check rules).'); }
          };
          actionsTd.appendChild(promote);
        }
      } else {
        const info = document.createElement('span'); info.className='small-muted'; info.textContent='Manage by super-admin';
        actionsTd.appendChild(info);
      }

      const viewProfile = document.createElement('button'); viewProfile.className='btn'; viewProfile.textContent='Open';
      viewProfile.onclick = ()=> {
        const consoleUrl = `https://console.firebase.google.com/project/${FIREBASE_CONFIG.projectId}/firestore/data/~2Fusers~2F${u.uid}`;
        window.open(consoleUrl, '_blank');
      };
      actionsTd.appendChild(viewProfile);

      tr.appendChild(nameTd);
      tr.appendChild(emailTd);
      tr.appendChild(gradeTd);
      tr.appendChild(phoneTd);
      tr.appendChild(teamTd);
      tr.appendChild(roleTd);
      tr.appendChild(adminTd);
      tr.appendChild(actionsTd);

      usersTbody.appendChild(tr);
    }
  }

  function escapeHtml(s){
    if(!s) return '';
    return String(s).replace(/[&<>"]/g, (c)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }

  // ---------- UI wiring ----------
  refreshBtn.onclick = ()=> { renderTable(); };
  filterInput.oninput = ()=> renderTable();

  document.addEventListener('keydown', (e)=>{
    if(document.activeElement && document.activeElement.tagName === 'INPUT') return;
    if(e.key === 'g' || e.key === 'G'){ filterInput.focus(); e.preventDefault(); }
  });

  usersTbody.innerHTML = '<tr><td colspan="8" class="small-muted">Waiting for authâ€¦</td></tr>';
})();
</script>
</body>
</html>
